<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å±±ä¸œå¤§å­¦ç»©ç‚¹å¯è§†åŒ– | SDU GPA Visualizer</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{
      --china-red-900:#7a0019;
      --china-red-700:#a6001a;
      --china-red-600:#c21807;
      --china-red-500:#d32f2f; /* ä¸»è‰²è°ƒ */
      --china-red-300:#ef5350;
      --china-gold:#d4af37;
      --bg:#fff9f7;
      --ink:#2b2b2b;
      --muted:#6b6b6b;
      --card:#ffffff;
      --ring:0 0 0 3px rgba(210,47,47,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:"SF Pro Display","Segoe UI",Roboto,Inter,system-ui,-apple-system,"Noto Sans SC","PingFang SC","Microsoft Yahei",sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--china-red-900),var(--china-red-600));color:#fff;padding:18px 20px;border-bottom:4px solid var(--china-gold)}
    h1{margin:0;font-size:22px;letter-spacing:.5px}
    .sub{opacity:.9;font-size:12px}
    main{max-width:1180px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:340px 1fr;gap:16px}
    @media (max-width: 768px) {
      main{grid-template-columns:1fr}
    }
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px;border:1px solid #eee}
    .card h2{font-size:16px;margin:0 0 10px;color:var(--china-red-700)}
    .uploader{border:2px dashed var(--china-red-300);border-radius:14px;padding:18px;text-align:center;background:#fff}
    .uploader.dragover{outline:var(--ring)}
    input[type=file]{display:none}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--china-red-600);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#fff;color:var(--china-red-700);border:1px solid var(--china-red-300)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted)}
    select, input[type=checkbox]{width:100%;padding:8px;border:1px solid #ddd;border-radius:10px;background:#fff}
    .meta{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
    .meta .kpi{background:linear-gradient(180deg,#fff,#fff3f1);border:1px solid #f2d6d6;border-radius:14px;padding:12px}
    .kpi .v{font-weight:800;font-size:18px;color:var(--china-red-700)}
    .kpi .t{font-size:12px;color:var(--muted)}
    #charts{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    @media (max-width: 768px) {
      #charts{grid-template-columns:1fr}
    }
    #charts > div{height:340px;background:#fff;border-radius:16px;border:1px solid #eee}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid #f2f2f2;font-size:12px}
    th{background:#fff5f5;color:#7a0019;position:sticky;top:0}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #f2d6d6;background:#fff9f9;color:#a6001a;font-size:11px}
    .pill.optional{background:#f0f9f0;border-color:#d6f2d6;color:#0a710a}
    .pill.excluded{background:#f9f0f0;border-color:#f2d6d6;color:#7a0019;opacity:0.7}
    footer{max-width:1180px;margin:24px auto 80px;padding:0 16px;color:#777}
    .notice{font-size:12px;line-height:1.4}
    .badge{display:inline-block;padding:2px 6px;border:1px dashed var(--china-red-300);border-radius:8px;color:var(--china-red-700);background:#fff}
    .hidden{display:none}
    .processing{text-align:center;padding:20px;color:var(--muted)}
    .processing .spinner{border:3px solid rgba(211,47,47,0.1);border-radius:50%;border-top:3px solid var(--china-red-500);width:24px;height:24px;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .course-selection{margin-top:16px;border-top:1px dashed #eee;padding-top:16px}
    .select-all{font-size:12px;margin-bottom:8px}
    .course-item{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:12px}
    .student-info{margin-top:12px;padding:10px;background:#fff5f5;border-radius:8px;font-size:12px}
  </style>
</head>
<body>
<header>
  <h1>ğŸ“• å±±ä¸œå¤§å­¦ç»©ç‚¹å¯è§†åŒ– | SDU GPA Visualizer</h1>
  <div class="sub">ä¸­å›½çº¢ä¸»é¢˜ Â· æˆç»©å•è§£æä¸å­¦ä¸šåˆ†æ Â· æœ¬åœ°å¤„ç†ä¿æŠ¤éšç§</div>
</header>
<main>
  <section class="card">
    <h2>1) ä¸Šä¼ /æ‹–æ‹½ PDF æˆç»©å•</h2>
    <div id="uploader" class="uploader" tabindex="0" aria-label="PDF uploader">
      <p style="margin:8px 0 14px">å°†å±±ä¸œå¤§å­¦å¯ä¿¡ç”µå­å‡­è¯æˆç»©å• PDF æ‹–æ‹½åˆ°æ­¤å¤„ï¼Œæˆ–</p>
      <label for="file" class="btn">é€‰æ‹©æ–‡ä»¶</label>
      <input id="file" type="file" accept="application/pdf" />
      <p style="font-size:12px;color:var(--muted);margin-top:8px">è¯´æ˜ï¼šæœ¬åœ°è§£æï¼Œæ–‡ä»¶ä¸ä¸Šä¼ æœåŠ¡å™¨</p>
    </div>

    <div id="student-info" class="student-info hidden">
      <div id="info-content"></div>
    </div>

    <div id="processing" class="processing hidden">
      <div class="spinner"></div>
      <p>æ­£åœ¨è§£ææˆç»©å•ï¼Œè¯·ç¨å€™...</p>
    </div>

    <h2 style="margin-top:18px">2) è®¡ç®—è®¾ç½®ï¼ˆå¯è°ƒï¼‰</h2>
    <div class="row">
      <div>
        <label>GPA æ–¹æ¡ˆï¼ˆScaleï¼‰</label>
        <select id="gpa-scale">
          <option value="score">åŠ æƒå¹³å‡åˆ†ï¼ˆ0â€“100ï¼‰</option>
          <option value="linear4">çº¿æ€§ 4.0ï¼ˆscore/100Ã—4ï¼‰</option>
          <option value="pku">åŒºé—´ 4.0ï¼ˆå¸¸ç”¨æ¡£ä½ï¼‰</option>
          <option value="sdu" selected>å±±å¤§æ ‡å‡† 4.0</option>
        </select>
      </div>
      <div>
        <label>è´¨åŒ–æˆç»©æ˜ å°„</label>
        <select id="qual-map">
          <option value="std" selected>ä¼˜ç§€95/è‰¯å¥½85/åˆæ ¼60/ä¸åˆæ ¼0</option>
          <option value="hi">ä¼˜ç§€97/è‰¯å¥½88/åˆæ ¼60/ä¸åˆæ ¼0</option>
          <option value="lo">ä¼˜ç§€90/è‰¯å¥½80/åˆæ ¼60/ä¸åˆæ ¼0</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div>
        <label><input type="checkbox" id="include-zero" /> çº³å…¥é›¶å­¦åˆ†è¯¾ç¨‹ï¼ˆå¦‚ CETï¼‰</label>
      </div>
      <div>
        <label><input type="checkbox" id="retake-rule" checked /> é‡ä¿®ä»…è®¡æœ€é«˜åˆ†ï¼ˆå«â€œ*â€æ ‡æ³¨ï¼‰</label>
      </div>
    </div>

    <div class="course-selection hidden" id="course-selection">
      <h2>3) è¯¾ç¨‹é€‰æ‹©ï¼ˆè®¡å…¥ç»©ç‚¹ï¼‰</h2>
      <div class="select-all">
        <label><input type="checkbox" id="select-all-required" checked /> å…¨é€‰å¿…ä¿®è¯¾</label>
        <label style="margin-left:10px"><input type="checkbox" id="select-all-limited" checked /> å…¨é€‰é™é€‰è¯¾</label>
        <label style="margin-left:10px"><input type="checkbox" id="select-all-optional" /> é€‰æ‹©ä»»é€‰è¯¾</label>
      </div>
      <div style="max-height:200px;overflow-y:auto;margin-top:8px;border:1px solid #eee;border-radius:8px;padding:8px">
        <div id="course-list" style="display:grid;grid-template-columns:1fr;gap:4px">
          <!-- è¯¾ç¨‹é€‰æ‹©åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <div class="meta">
      <div class="kpi"><div class="t">è¯¾ç¨‹æ•° / æ€»å­¦åˆ†</div><div class="v" id="kpi-courses">â€”</div></div>
      <div class="kpi"><div class="t">ç´¯è®¡åŠ æƒåˆ† / GPA</div><div class="v" id="kpi-gpa">â€”</div></div>
      <div class="kpi"><div class="t">å¿…ä¿®/é™é€‰/ä»»é€‰ å­¦åˆ†</div><div class="v" id="kpi-attr">â€”</div></div>
      <div class="kpi"><div class="t">æ—¶é—´èŒƒå›´</div><div class="v" id="kpi-range">â€”</div></div>
    </div>
  </section>

  <section class="card">
    <h2>å­¦ä¸šç”»åƒä¸å¯è§†åŒ–</h2>
    <div id="charts">
      <div id="chart-semester" aria-label="å­¦æœŸç»©ç‚¹è¶‹åŠ¿"></div>
      <div id="chart-attr" aria-label="è¯¾ç¨‹ç±»å‹å­¦åˆ†å æ¯”"></div>
      <div id="chart-hist" aria-label="æˆç»©åˆ†å¸ƒç›´æ–¹å›¾"></div>
      <div id="chart-top" aria-label="è¯¾ç¨‹è´¡çŒ®åº¦TOP10"></div>
    </div>
    <h2 style="margin-top:16px">è¯¾ç¨‹æ˜ç»†</h2>
    <div style="max-height:380px;overflow:auto;border:1px solid #eee;border-radius:12px">
      <table id="tbl">
        <thead>
          <tr>
            <th>å­¦æœŸ</th><th>è¯¾ç¨‹å</th><th>ç±»å‹</th><th>å­¦åˆ†</th><th>æˆç»©</th><th>è®¡å…¥</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="notice">
      <span class="badge">æ–¹æ³•å­¦è¯´æ˜</span> æœ¬å·¥å…·é€‚é…å±±ä¸œå¤§å­¦æˆç»©å•æ ¼å¼ï¼Œè‡ªåŠ¨è¯†åˆ«å¿…ä¿®è¯¾ã€é™é€‰è¯¾å’Œä»»é€‰è¯¾ï¼ˆé»˜è®¤ä¸è®¡å…¥ç»©ç‚¹ï¼‰ã€‚
      è´¨åŒ–æˆç»©ï¼ˆå¦‚â€œä¼˜ç§€/è‰¯å¥½/åˆæ ¼â€ï¼‰æŒ‰è®¾ç½®è§„åˆ™æ¢ç®—ä¸ºæ•°å€¼ï¼›GPAæŒ‰å­¦åˆ†åŠ æƒè®¡ç®—ï¼š
      <code>GPA = (âˆ‘ å­¦åˆ†Ã—ç»©ç‚¹)/(âˆ‘ å­¦åˆ†)</code>ã€‚ä¸åŒé™¢æ ¡æ”¿ç­–å­˜åœ¨å·®å¼‚ï¼Œè¯·ä»¥å®˜æ–¹è§£é‡Šä¸ºå‡†ã€‚
    </p>
  </section>
</main>

<footer>
  <div class="notice">
    æ•°æ®ä»…åœ¨æœ¬åœ°æµè§ˆå™¨å†…å¤„ç†ï¼Œä¸ä¼šä¸Šä¼ æœåŠ¡å™¨ã€‚PDFè§£æç”± <strong>PDF.js</strong> å®Œæˆï¼Œå¯è§†åŒ–ç”± <strong>ECharts</strong> æä¾›ã€‚
  </div>
</footer>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.js";

  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

  const uploader = document.getElementById('uploader');
  const fileInput = document.getElementById('file');
  const processing = document.getElementById('processing');
  const courseSelection = document.getElementById('course-selection');
  const courseList = document.getElementById('course-list');
  const studentInfo = document.getElementById('student-info');
  const infoContent = document.getElementById('info-content');

  // åº”ç”¨çŠ¶æ€ç®¡ç†
  const state = {
    rawRows: [],       // åŸå§‹è§£æçš„è¯¾ç¨‹æ•°æ®
    processedRows: [], // å¤„ç†åçš„è¯¾ç¨‹æ•°æ®
    student: {},       // å­¦ç”Ÿä¿¡æ¯
    settings: {
      scale: 'sdu', 
      qual: 'std', 
      includeZero: false, 
      retake: true,
      include: {}       // å­˜å‚¨è¯¾ç¨‹æ˜¯å¦è®¡å…¥ç»©ç‚¹çš„çŠ¶æ€
    }
  };

  /**
   * å°†è´¨åŒ–æˆç»©è½¬æ¢ä¸ºé‡åŒ–åˆ†æ•°
   * @param {string} val - è´¨åŒ–æˆç»©ï¼ˆä¼˜ç§€/è‰¯å¥½ç­‰ï¼‰
   * @param {string} map - æ˜ å°„æ–¹æ¡ˆ
   * @returns {number} è½¬æ¢åçš„åˆ†æ•°
   */
  function parseQualitative(val, map) {
    const base = { 'ä¼˜ç§€':95, 'è‰¯å¥½':85, 'ä¸­ç­‰':75, 'åˆæ ¼':60, 'ä¸åˆæ ¼':0, 'ç¼“è€ƒ':0, 'ä¼˜ç§€ ':95, 'è‰¯å¥½ ':85 };
    if(map === 'hi') { base['ä¼˜ç§€'] = 97; base['è‰¯å¥½'] = 88; }
    if(map === 'lo') { base['ä¼˜ç§€'] = 90; base['è‰¯å¥½'] = 80; }
    return base[val] ?? null;
  }

  /**
   * å°†åˆ†æ•°è½¬æ¢ä¸ºGPA
   * @param {number} score - åŸå§‹åˆ†æ•°
   * @param {string} scale - GPAè®¡ç®—æ–¹æ¡ˆ
   * @returns {number} è½¬æ¢åçš„GPA
   */
  function toGPA(score, scale) {
    if (scale === 'linear4') return Math.min(4.0, (score / 100) * 4);
    
    // å±±ä¸œå¤§å­¦æ ‡å‡†GPAè®¡ç®—æ–¹æ¡ˆ
    if (scale === 'sdu') {
      if (score >= 90) return 4.0;
      if (score >= 85) return 3.7;
      if (score >= 82) return 3.3;
      if (score >= 78) return 3.0;
      if (score >= 75) return 2.7;
      if (score >= 72) return 2.3;
      if (score >= 68) return 2.0;
      if (score >= 64) return 1.5;
      if (score >= 60) return 1.0;
      return 0;
    }
    
    // å¸¸ç”¨åŒºé—´4.0æ–¹æ¡ˆ
    if (scale === 'pku') {
      if (score >= 90) return 4.0;
      if (score >= 85) return 3.7;
      if (score >= 82) return 3.3;
      if (score >= 78) return 3.0;
      if (score >= 75) return 2.7;
      if (score >= 72) return 2.3;
      if (score >= 68) return 2.0;
      if (score >= 64) return 1.5;
      if (score >= 60) return 1.0;
      return 0;
    }
    
    // é»˜è®¤è¿”å›åŸå§‹åˆ†æ•°ï¼ˆåŠ æƒå¹³å‡åˆ†ï¼‰
    return score;
  }

  /**
   * è®¡ç®—åŠ æƒå¹³å‡å€¼
   * @param {Array} items - æ•°æ®é¡¹æ•°ç»„
   * @param {string} key - æ•°å€¼å­—æ®µå
   * @param {string} wkey - æƒé‡å­—æ®µå
   * @returns {number} åŠ æƒå¹³å‡å€¼
   */
  function weightedMean(items, key = 'score', wkey = 'credit') {
    let num = 0, den = 0;
    for (const x of items) {
      const w = Number(x[wkey]) || 0;
      const v = Number(x[key]);
      if (!Number.isFinite(w) || !Number.isFinite(v)) continue;
      num += w * v;
      den += w;
    }
    return den > 0 ? num / den : NaN;
  }

  /**
   * æ ¼å¼åŒ–å­¦æœŸæ˜¾ç¤º
   * @param {Array} tokens - å­¦æœŸæ ‡è¯†ä»¤ç‰Œ
   * @returns {string} æ ¼å¼åŒ–åçš„å­¦æœŸå­—ç¬¦ä¸²
   */
  function formatSemesterTokens(tokens) {
    const year = tokens[0];
    let term = tokens[1];
    // è½¬æ¢ç½—é©¬æ•°å­—ä¸ºä¸­æ–‡è¡¨è¿°
    const termMap = { 'â… ': 'ä¸€', 'â…¡': 'äºŒ', 'â…¢': 'ä¸‰', 'I': 'ä¸€', 'II': 'äºŒ', 'III': 'ä¸‰' };
    term = termMap[term] || term;
    return `${year}å¹´ç¬¬${term}å­¦æœŸ`;
  }

  /**
   * è¯»å–PDFæ–‡ä»¶å†…å®¹
   * @param {File} file - PDFæ–‡ä»¶
   * @returns {Promise<string>} PDFæ–‡æœ¬å†…å®¹
   */
  async function readPdf(file) {
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    let text = '';
    for (let p = 1; p <= pdf.numPages; p++) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      text += content.items.map(i => i.str).join(' ') + '\n';
    }
    return text;
  }

  /**
   * æ ‡å‡†åŒ–æ–‡æœ¬å†…å®¹
   * @param {string} s - åŸå§‹æ–‡æœ¬
   * @returns {string} æ ‡å‡†åŒ–åçš„æ–‡æœ¬
   */
  function normalizeText(s) {
    return s.replace(/\s+/g, ' ')
           .replace(/ï¼ˆ/g, '(')
           .replace(/ï¼‰/g, ')')
           .replace(/ï¼Œ/g, ',')
           .replace(/ï¼›/g, ';')
           .replace(/ï¼š/g, ':')
           .trim();
  }

  /**
   * è§£ææˆç»©å•æ–‡æœ¬å†…å®¹
   * @param {string} raw - åŸå§‹æ–‡æœ¬
   * @returns {Object} è§£æç»“æœ
   */
  function parseTranscriptText(raw) {
    const t = normalizeText(raw);

    // æå–å­¦ç”ŸåŸºæœ¬ä¿¡æ¯
    const nameMatch = t.match(/å§“å\s*[:ï¼š]\s*([\u4e00-\u9fa5]{2,})/);
    const idMatch = t.match(/å­¦å·\s*[:ï¼š]\s*(\d{8,})/);
    const collegeMatch = t.match(/å­¦é™¢\s*[:ï¼š]\s*([^\s,;]+)/);
    const majorMatch = t.match(/ä¸“ä¸š\s*[:ï¼š]\s*([^\s,;]+)/);
    const avgMatch = t.match(/å¹³å‡å­¦åˆ†ç»©ç‚¹\s*[:ï¼š]\s*(\d{1,2}\.\d{2})/);

    // è§£æè¯¾ç¨‹æ•°æ®
    const tokens = t.split(' ');
    const rows = [];
    const attrKeywords = ['å¿…ä¿®', 'é™é€‰', 'ä»»é€‰']; // è¯¾ç¨‹å±æ€§å…³é”®è¯

    // å±±ä¸œå¤§å­¦æˆç»©å•è¯¾ç¨‹è¡Œæ¨¡å¼ï¼šå­¦æœŸ + è¯¾ç¨‹å + å±æ€§ + å­¦åˆ† + å­¦æ—¶ + æˆç»©
    for (let i = 0; i < tokens.length; i++) {
      // æ£€æµ‹å­¦æœŸæ ‡è¯†ï¼š4ä½å¹´ä»½ + ç½—é©¬æ•°å­—(â… /â…¡/â…¢æˆ–I/II/III)
      if (/^(19|20)\d{2}$/.test(tokens[i]) && /^(â… |â…¡|â…¢|I|II|III)$/.test(tokens[i + 1] || '')) {
        const sem = formatSemesterTokens([tokens[i], tokens[i + 1]]);
        let j = i + 2;
        let nameParts = [];
        
        // æå–è¯¾ç¨‹åç§°ï¼ˆç›´åˆ°é‡åˆ°å±æ€§å…³é”®è¯ï¼‰
        while (j < tokens.length && !attrKeywords.includes(tokens[j])) {
          nameParts.push(tokens[j]);
          j++;
        }
        
        // æå–è¯¾ç¨‹å±æ€§
        const attr = tokens[j] || '';
        if (!attrKeywords.includes(attr)) {
          i = j;
          continue; // ä¸æ˜¯æœ‰æ•ˆè¯¾ç¨‹è¡Œï¼Œè·³è¿‡
        }
        
        // æå–å­¦åˆ†ã€å­¦æ—¶å’Œæˆç»©
        const credit = parseFloat(tokens[j + 1]) || 0;
        const hours = tokens[j + 2] || ''; // å­¦æ—¶ä¿¡æ¯æš‚ä¸ä½¿ç”¨
        let gradeToken = tokens[j + 3] || '';
        
        // æ£€æµ‹æ˜¯å¦ä¸ºé‡ä¿®è¯¾ç¨‹ï¼ˆæˆç»©å¸¦*æ ‡è®°ï¼‰
        let retake = false;
        if (gradeToken.includes('*')) {
          retake = true;
          gradeToken = gradeToken.replace('*', '');
        }
        
        // è¯¾ç¨‹åç§°å¤„ç†
        const name = nameParts.join(' ').trim();
        if (!name || name.length > 60) { // è¿‡æ»¤æ— æ•ˆè¯¾ç¨‹å
          i = j + 3;
          continue;
        }
        
        // å¤„ç†æˆç»©
        let numeric = null, qualitative = null;
        if (/^\d{1,3}$/.test(gradeToken)) {
          numeric = parseInt(gradeToken, 10);
        } else {
          qualitative = gradeToken;
        }

        // æ·»åŠ è¯¾ç¨‹æ•°æ®
        rows.push({
          id: `${sem}-${name}`, // ç”Ÿæˆå”¯ä¸€ID
          semester: sem,
          name,
          attr,
          credit,
          gradeRaw: gradeToken,
          gradeNum: numeric,
          gradeQual: qualitative,
          isRetake: retake
        });
        
        i = j + 3; // è·³è‡³ä¸‹ä¸€ä¸ªå¯èƒ½çš„è¯¾ç¨‹è¡Œ
      }
    }

    return {
      name: nameMatch?.[1] || '',
      sid: idMatch?.[1] || '',
      college: collegeMatch?.[1] || '',
      major: majorMatch?.[1] || '',
      averageReported: avgMatch?.[1] || '',
      rows
    };
  }

  /**
   * ç”Ÿæˆè¯¾ç¨‹é€‰æ‹©åˆ—è¡¨
   * @param {Array} rows - è¯¾ç¨‹æ•°æ®
   */
  function generateCourseSelection(rows) {
    courseList.innerHTML = '';
    state.settings.include = {}; // é‡ç½®é€‰æ‹©çŠ¶æ€
    
    // æŒ‰è¯¾ç¨‹ç±»å‹é¢„è®¾é€‰æ‹©çŠ¶æ€
    rows.forEach(row => {
      // é»˜è®¤ä¸ºï¼šå¿…ä¿®è¯¾å’Œé™é€‰è¯¾è®¡å…¥ï¼Œä»»é€‰è¯¾ä¸è®¡å…¥
      const defaultInclude = row.attr === 'å¿…ä¿®' || row.attr === 'é™é€‰';
      state.settings.include[row.id] = defaultInclude;
      
      // åˆ›å»ºè¯¾ç¨‹é€‰æ‹©é¡¹
      const item = document.createElement('div');
      item.className = 'course-item';
      item.innerHTML = `
        <input type="checkbox" id="course-${row.id}" ${defaultInclude ? 'checked' : ''} 
               data-id="${row.id}" data-attr="${row.attr}">
        <label for="course-${row.id}" title="${row.name} (${row.semester})">
          ${row.name.length > 18 ? row.name.substring(0, 18) + '...' : row.name}
          <span class="pill ${row.attr === 'ä»»é€‰' ? 'optional' : ''}">${row.attr}</span>
        </label>
      `;
      courseList.appendChild(item);
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬
      item.querySelector('input').addEventListener('change', function() {
        state.settings.include[this.dataset.id] = this.checked;
        refresh();
      });
    });
    
    // å…¨é€‰åŠŸèƒ½
    $('#select-all-required').addEventListener('change', function() {
      $$(`input[data-attr="å¿…ä¿®"]`).forEach(checkbox => {
        checkbox.checked = this.checked;
        state.settings.include[checkbox.dataset.id] = this.checked;
      });
      refresh();
    });
    
    $('#select-all-limited').addEventListener('change', function() {
      $$(`input[data-attr="é™é€‰"]`).forEach(checkbox => {
        checkbox.checked = this.checked;
        state.settings.include[checkbox.dataset.id] = this.checked;
      });
      refresh();
    });
    
    $('#select-all-optional').addEventListener('change', function() {
      $$(`input[data-attr="ä»»é€‰"]`).forEach(checkbox => {
        checkbox.checked = this.checked;
        state.settings.include[checkbox.dataset.id] = this.checked;
      });
      refresh();
    });
  }

  /**
   * åº”ç”¨è®¾ç½®å¤„ç†è¯¾ç¨‹æ•°æ®
   * @param {Array} rawRows - åŸå§‹è¯¾ç¨‹æ•°æ®
   * @returns {Array} å¤„ç†åçš„è¯¾ç¨‹æ•°æ®
   */
  function applySettings(rawRows) {
    const includeZero = $('#include-zero').checked;
    const retakeHighest = $('#retake-rule').checked;
    const qualMap = $('#qual-map').value;
    
    // è½¬æ¢æˆç»©å¹¶åº”ç”¨é€‰æ‹©çŠ¶æ€
    const processed = rawRows.map(row => {
      let score = row.gradeNum;
      if (score === null && row.gradeQual) {
        score = parseQualitative(row.gradeQual, qualMap);
      }
      
      // åº”ç”¨è¯¾ç¨‹é€‰æ‹©çŠ¶æ€
      const manuallyIncluded = state.settings.include[row.id];
      // é›¶å­¦åˆ†è¯¾ç¨‹è¿‡æ»¤
      const creditOk = includeZero || (row.credit || 0) > 0;
      // æœ‰æ•ˆæˆç»©æ£€æŸ¥
      const scoreOk = Number.isFinite(score);
      
      return {
        ...row,
        score,
        include: manuallyIncluded && creditOk && scoreOk
      };
    });
    
    // å¤„ç†é‡ä¿®è¯¾ç¨‹ï¼ˆåªä¿ç•™æœ€é«˜åˆ†ï¼‰
    if (retakeHighest) {
      const courseMap = new Map();
      processed.forEach(row => {
        if (!row.include) return;
        
        const key = row.name; // æŒ‰è¯¾ç¨‹åè¯†åˆ«åŒä¸€è¯¾ç¨‹
        const existing = courseMap.get(key);
        
        if (!existing || row.score > existing.score) {
          courseMap.set(key, row);
          // å¦‚æœæœ‰æ—§è®°å½•ï¼Œæ ‡è®°ä¸ºä¸è®¡å…¥
          if (existing) {
            existing.include = false;
          }
        } else {
          row.include = false;
        }
      });
    }
    
    return processed;
  }

  /**
   * åˆ·æ–°ç•Œé¢æ˜¾ç¤º
   */
  function refresh() {
    const rows = applySettings(state.rawRows);
    state.processedRows = rows;
    const scale = $('#gpa-scale').value;

    const rowsIn = rows.filter(r => r.include);
    // è®¡ç®—ç»Ÿè®¡æ•°æ®
    const weightedScore = weightedMean(rowsIn, 'score', 'credit');
    const gValues = rowsIn.map(r => ({ ...r, g: toGPA(r.score, scale) }));
    const weightedG = weightedMean(gValues, 'g', 'credit');

    // æ›´æ–°KPIæ˜¾ç¤º
    $('#kpi-courses').textContent = `${rows.length} / ${rowsIn.reduce((a, b) => a + (b.credit || 0), 0).toFixed(1)} å­¦åˆ†`;
    $('#kpi-gpa').textContent = scale === 'score' 
      ? `${weightedScore.toFixed(2)}` 
      : `${weightedG.toFixed(3)} (4.0)`;
    
    // æŒ‰è¯¾ç¨‹ç±»å‹ç»Ÿè®¡å­¦åˆ†
    const byAttr = { 'å¿…ä¿®': 0, 'é™é€‰': 0, 'ä»»é€‰': 0 };
    rowsIn.forEach(r => {
      if (byAttr.hasOwnProperty(r.attr)) {
        byAttr[r.attr] += r.credit || 0;
      }
    });
    $('#kpi-attr').textContent = `å¿…ä¿®:${byAttr.å¿…ä¿®.toFixed(1)} / é™é€‰:${byAttr.é™é€‰.toFixed(1)} / ä»»é€‰:${byAttr.ä»»é€‰.toFixed(1)}`;

    // æ—¶é—´èŒƒå›´
    const semesters = [...new Set(rows.map(r => r.semester))].sort();
    if (semesters.length) {
      $('#kpi-range').textContent = `${semesters[0]} â€” ${semesters[semesters.length - 1]}`;
    }

    // æ›´æ–°è¯¾ç¨‹è¡¨æ ¼
    const tbody = $('#tbl tbody');
    tbody.innerHTML = '';
    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.style.opacity = r.include ? 1 : 0.6;
      const gradeDisplay = r.gradeNum !== null ? r.gradeNum : r.gradeQual || 'â€”';
      const includeDisplay = r.include 
        ? `<span class="pill">æ˜¯</span>` 
        : `<span class="pill excluded">å¦</span>`;
      
      const cells = [
        r.semester,
        r.name,
        `<span class="pill ${r.attr === 'ä»»é€‰' ? 'optional' : ''}">${r.attr}</span>`,
        (r.credit || 0).toFixed(1),
        gradeDisplay,
        includeDisplay
      ];
      
      tr.innerHTML = cells.map(c => `<td>${c}</td>`).join('');
      tbody.appendChild(tr);
    }

    // ç»˜åˆ¶å›¾è¡¨
    drawCharts(rowsIn, scale);
  }

  /**
   * æŒ‰å±æ€§åˆ†ç»„æ±‚å’Œ
   * @param {Array} arr - æ•°æ®æ•°ç»„
   * @param {Function} keyFn - åˆ†ç»„é”®å‡½æ•°
   * @param {Function} valFn - å€¼å‡½æ•°
   * @returns {Object} åˆ†ç»„æ±‚å’Œç»“æœ
   */
  function groupSum(arr, keyFn, valFn) {
    const m = {};
    for (const x of arr) {
      const k = keyFn(x);
      m[k] = (m[k] || 0) + (valFn(x) || 0);
    }
    return m;
  }

  /**
   * ç»˜åˆ¶å›¾è¡¨
   * @param {Array} rowsIn - è®¡å…¥ç»©ç‚¹çš„è¯¾ç¨‹æ•°æ®
   * @param {string} scale - GPAè®¡ç®—æ–¹æ¡ˆ
   */
  function drawCharts(rowsIn, scale) {
    // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
    const ec1 = echarts.init(document.getElementById('chart-semester'));
    const ec2 = echarts.init(document.getElementById('chart-attr'));
    const ec3 = echarts.init(document.getElementById('chart-hist'));
    const ec4 = echarts.init(document.getElementById('chart-top'));

    // 1. å­¦æœŸç»©ç‚¹è¶‹åŠ¿å›¾
    const bySem = {};
    for (const r of rowsIn) {
      const g = toGPA(r.score, scale);
      (bySem[r.semester] ||= []).push({ g, w: r.credit || 0 });
    }
    const semCats = Object.keys(bySem).sort();
    const semVals = semCats.map(k => {
      const xs = bySem[k];
      const m = xs.reduce((a, b) => ({ num: a.num + b.g * b.w, den: a.den + b.w }), { num: 0, den: 0 });
      return m.den > 0 ? m.num / m.den : 0;
    });

    ec1.setOption({
      backgroundColor: '#fff',
      title: { text: 'å­¦æœŸ ' + (scale === 'score' ? 'åŠ æƒå¹³å‡åˆ†' : 'GPA') },
      tooltip: { trigger: 'axis' },
      xAxis: { 
        type: 'category', 
        data: semCats,
        axisLabel: {
          rotate: 30,
          interval: 0
        }
      },
      yAxis: { 
        type: 'value', 
        name: scale === 'score' ? 'åˆ†æ•°' : 'GPA (4.0)'
      },
      series: [{ 
        type: 'line', 
        data: semVals, 
        smooth: true, 
        areaStyle: {},
        lineStyle: { width: 3 },
        itemStyle: { color: '#d32f2f' }
      }],
      color: ['#d32f2f']
    });

    // 2. è¯¾ç¨‹ç±»å‹å­¦åˆ†å æ¯”å›¾
    const attrSum = groupSum(rowsIn, r => r.attr, r => r.credit || 0);
    const pieData = Object.entries(attrSum)
      .filter(([k, v]) => v > 0)
      .map(([k, v]) => ({ name: k + 'è¯¾', value: Number(v.toFixed(2)) }));
    
    ec2.setOption({
      backgroundColor: '#fff',
      title: { text: 'å­¦åˆ†ç»“æ„ï¼ˆæŒ‰è¯¾ç¨‹ç±»å‹ï¼‰' },
      tooltip: { trigger: 'item' },
      legend: {
        orient: 'vertical',
        left: 10
      },
      series: [{ 
        type: 'pie', 
        radius: ['35%', '65%'], 
        data: pieData,
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        }
      }],
      color: ['#d32f2f', '#ef5350', '#f8bbd0']
    });

    // 3. æˆç»©åˆ†å¸ƒç›´æ–¹å›¾
    const bins = scale === 'score' 
      ? [0,60,70,80,90,101] 
      : [0,1,2,3,4.1];
    const binLabels = scale === 'score'
      ? ['<60', '60-69', '70-79', '80-89', '90+']
      : ['<1.0', '1.0-1.9', '2.0-2.9', '3.0-4.0'];
      
    const counts = new Array(bins.length - 1).fill(0);
    rowsIn.forEach(r => {
      const value = scale === 'score' ? r.score : toGPA(r.score, scale);
      for (let i = 0; i < bins.length - 1; i++) {
        if (value >= bins[i] && value < bins[i + 1]) {
          counts[i]++;
          break;
        }
      }
    });

    ec3.setOption({
      backgroundColor: '#fff',
      title: { text: scale === 'score' ? 'æˆç»©åˆ†å¸ƒ' : 'GPAåˆ†å¸ƒ' },
      tooltip: {},
      xAxis: { 
        type: 'category', 
        data: binLabels 
      },
      yAxis: { type: 'value', name: 'è¯¾ç¨‹æ•°' },
      series: [{ 
        type: 'bar', 
        data: counts,
        itemStyle: {
          color: function(params) {
            const colorList = ['#f44336', '#ff9800', '#ffeb3b', '#4caf50'];
            return colorList[params.dataIndex] || '#2196f3';
          }
        }
      }]
    });

    // 4. è¯¾ç¨‹è´¡çŒ®åº¦TOP10
    const top = [...rowsIn]
      .sort((a, b) => (b.score * (b.credit || 0)) - (a.score * (a.credit || 0)))
      .slice(0, 10);

    ec4.setOption({
      backgroundColor: '#fff',
      title: { text: 'è¯¾ç¨‹è´¡çŒ®åº¦TOP10 (æˆç»©Ã—å­¦åˆ†)' },
      tooltip: {},
      grid: {
        left: '30%',
        right: '5%',
        top: '15%',
        bottom: '10%'
      },
      xAxis: { type: 'value' },
      yAxis: { 
        type: 'category', 
        data: top.map(r => r.name),
        axisLabel: {
          interval: 0,
          formatter: function(value) {
            return value.length > 6 ? value.substring(0, 6) + '...' : value;
          }
        }
      },
      series: [{ 
        type: 'bar', 
        data: top.map(r => Number((r.score * (r.credit || 0)).toFixed(2))),
        itemStyle: { color: '#c21807' }
      }]
    });

    // å“åº”çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
      ec1.resize();
      ec2.resize();
      ec3.resize();
      ec4.resize();
    });
  }

  /**
   * åˆå§‹åŒ–åº”ç”¨
   */
  function setup() {
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function triggerRead(file) {
      if (!file) return;
      
      // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
      uploader.classList.add('hidden');
      processing.classList.remove('hidden');
      
      readPdf(file)
        .then(txt => {
          const parsed = parseTranscriptText(txt);
          state.rawRows = parsed.rows;
          state.student = {
            name: parsed.name,
            sid: parsed.sid,
            college: parsed.college,
            major: parsed.major,
            averageReported: parsed.averageReported
          };
          
          // æ˜¾ç¤ºå­¦ç”Ÿä¿¡æ¯
          studentInfo.classList.remove('hidden');
          infoContent.innerHTML = `
            <div>å§“åï¼š${state.student.name || 'æœªçŸ¥'}</div>
            <div>å­¦å·ï¼š${state.student.sid || 'æœªçŸ¥'}</div>
            <div>å­¦é™¢ï¼š${state.student.college || 'æœªçŸ¥'}</div>
            <div>ä¸“ä¸šï¼š${state.student.major || 'æœªçŸ¥'}</div>
            ${state.student.averageReported ? 
              `<div>å®˜æ–¹GPAï¼š<span style="color:var(--china-red-600)">${state.student.averageReported}</span></div>` : ''
            }
          `;
          
          // ç”Ÿæˆè¯¾ç¨‹é€‰æ‹©åˆ—è¡¨
          generateCourseSelection(parsed.rows);
          courseSelection.classList.remove('hidden');
          
          // åˆ·æ–°æ˜¾ç¤º
          refresh();
          
          // éšè—å¤„ç†çŠ¶æ€ï¼Œæ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
          processing.classList.add('hidden');
          uploader.classList.remove('hidden');
        })
        .catch(err => {
          console.error('è§£æå¤±è´¥:', err);
          alert('è§£æå¤±è´¥ï¼š' + err.message + '\nè¯·ç¡®è®¤ä¸Šä¼ çš„æ˜¯å±±ä¸œå¤§å­¦æ ‡å‡†æˆç»©å•PDF');
          processing.classList.add('hidden');
          uploader.classList.remove('hidden');
        });
    }

    // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
    fileInput.addEventListener('change', e => triggerRead(e.target.files?.[0]));

    // æ‹–æ”¾äº‹ä»¶å¤„ç†
    ['dragenter', 'dragover'].forEach(ev => {
      uploader.addEventListener(ev, (e) => {
        e.preventDefault();
        uploader.classList.add('dragover');
      });
    });
    
    ['dragleave', 'drop'].forEach(ev => {
      uploader.addEventListener(ev, (e) => {
        e.preventDefault();
        uploader.classList.remove('dragover');
      });
    });
    
    uploader.addEventListener('drop', e => {
      const f = e.dataTransfer.files?.[0];
      triggerRead(f);
    });

    // è®¾ç½®å˜æ›´äº‹ä»¶
    $('#gpa-scale').addEventListener('change', refresh);
    $('#qual-map').addEventListener('change', refresh);
    $('#include-zero').addEventListener('change', refresh);
    $('#retake-rule').addEventListener('change', refresh);
  }

  // åˆå§‹åŒ–åº”ç”¨
  setup();
</script>
</body>
</html>
    